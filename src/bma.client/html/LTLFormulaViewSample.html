<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>LTL Formula View Sample</title>
    <link rel="stylesheet" type="text/css" href="../css/idd.css" />
    <link rel="stylesheet" href="../css/BMA_less.min.css" type="text/css" />
    <link rel="stylesheet" href="../css/StyleSheet.min.css" type="text/css" />

    <script src="../Scripts/jquery-2.1.1.min.js"></script>
    <script src="../Scripts/jquery-ui-1.10.4.min.js"></script>
    <script src="../js/jquery.svg.min.js"></script>
    <script src="../js/rx.js"></script>
    <script src="../js/rx.jQuery.js"></script>
    <script src="../js/idd.js"></script>
    <script src="../js/svgplot.js"></script>
    <script src="../tool.js"></script>

    <script>

        function GetOperationDepth(op) {

        }

        /*
        function GetOperationSVG(svg: any, position: { x: number; y: number }, op: BMA.LTLOperations.Operation): string {
            var operator = op.Operator;
            var operands = op.Operands;
            return GetOperatorSVG(svg, position, operator, operands);
        }

        function GetOperandSVG(svg: any, position: { x: number; y: number }, op: BMA.LTLOperations.IOperand): { svg: any; depthLevel: number } {

            //TODO: Rethink method of distingushing keyframes from operations
            var operator = (<any>op).Operator;

            if (operator !== undefined) {
                return GetOperationSVG(svg, position, <BMA.LTLOperations.Operation>op);
            } else {
                return {
                    svg: GetKeyFrameSVG(svg, position, <BMA.LTLOperations.Keyframe>op), depthLevel: 1
                };
            }
        }

        function GetKeyFrameSVG(svg: any, position: { x: number; y: number }, keyframe: BMA.LTLOperations.Keyframe): string {
            return "";
        }

        function GetOperatorSVG(svg: any, position: { x: number; y: number }, op: BMA.LTLOperations.Operator, operands: BMA.LTLOperations.IOperand[]): { svg: any; depthLevel: number } {
            if (operands.length !== op.OperandsCount)
                throw "Invalid Operands Count for Operator's rendering";

            var operandSVGs = [];
            for (var i = 0; i < operands.length; i++) {
                operandSVGs.push(GetOperandSVG(svg, position, operands[i]));
            }

            switch (operands.length) {
                case 1:
                    return {
                        svg: undefined,
                        depthLevel: (<any>operandSVGs[0]).depthLevel
                    }
                    break;
                case 2:
                    return {
                        svg: undefined,
                        depthLevel: Math.max((<any>operandSVGs[0]).depthLevel,(<any>operandSVGs[1]).depthLevel)
                    }
                    break;
                default:
                    throw "Rendering of operators with " + operands.length + " operands is not supported";
            }
        }
        */

        $(document).ready(function () {
            //Creating CommandRegistry
            window.Commands = new BMA.CommandRegistry();

            //Loading widgets
            var drawingSurface = $("#drawingSurface");
            drawingSurface.drawingsurface();

            //Loading Drivers
            var svgPlotDriver = new BMA.UIDrivers.SVGPlotDriver(drawingSurface);

            var elementPanel = $("#modelelemtoolbar");
            var registry = new BMA.LTLOperations.OperatorsRegistry();
            for (var i = 0; i < registry.Operators.length; i++) {
                var operator = registry.Operators[i];

                $("<input></input>")
                    .attr("type", "radio")
                    .attr("id", "btn-" + operator.Name)
                    .attr("name", "drawing-button")
                    .attr("data-type", operator.Name)
                    .appendTo(elementPanel);

                var label = $("<label></label>").attr("data-operator", operator.Name).css("border", "none").css("border-radius", "50px 50px 50px 50px").attr("for", "btn-" + operator.Name).css("z-index", 9999999).appendTo(elementPanel);
                var img = $("<div></div>").css("overflow", "hidden").attr("title", operator.Name).appendTo(label);

                img.svg({
                    onLoad: function (svg) {
                        svg.configure({
                            width: img.width(),
                            height: img.height(),
                            viewBox: "-10 -10 20 20",
                            preserveAspectRatio: "none meet"
                        }, true);

                        var op = new BMA.LTLOperations.Operation();
                        op.Operator = registry.GetOperatorByName(operator.Name);
                        op.Operands = op.Operator.OperandsCount > 1 ? [undefined, undefined] : [undefined];
                        var operationLayout = new BMA.LTLOperations.OperationLayout(svg, op, { x: 0, y: 0 });

                        var bbox = operationLayout.BoundingBox;
                        svg.configure({
                            width: bbox.width,
                            height: bbox.height,
                            viewBox: (bbox.x - 1) + " " + (bbox.y - 1) + " " + (bbox.width + 2) + " " + (bbox.height + 2),
                            preserveAspectRatio: "none meet"
                        });

                        img.width(bbox.width).height(bbox.height);
                        label.width(bbox.width).height(bbox.height);
                    }
                });

                label.draggable({ helper: "clone" });
            }

            elementPanel.buttonset();
            $("#undoredotoolbar").buttonset();

            $("#modelelemtoolbar input").click(function (event) {
                window.Commands.Execute("AddOperatorSelect", $(this).attr("data-type"));
            });

            $("#button-pointer").click(function (event) {
                window.Commands.Execute("AddOperatorSelect", undefined);
            });


            var tpPresenter = new BMA.LTL.TemporalPropertiesPresenter(svgPlotDriver, svgPlotDriver, svgPlotDriver);

            svgPlotDriver.SetGridVisibility(false);
        });
    </script>
</head>
<body>
    <div id="tools" class="bma-toolbarpanel">
        <div id="undoredotoolbar" class="undoredo-toolbar">
            <input type="radio" id="button-pointer" name="drawing-button" checked="checked" />
            <label for="button-pointer">
                <img class="pointer-icon" title="Selection tool" />
            </label>

            <!--<button id="button-undo">
                <div class="undo-icon" title="Undo"></div>
            </button>
            <button id="button-redo">
                <div class="redo-icon" title="Redo"></div>
            </button>-->
        </div>

        <div id="modelelemtoolbar" class="elements-toolbar"></div>
    </div>

    <div id="drawingSurceContainer" class="bma-drawingsurfacecontainer">
        <div id="drawingSurface" class="bma-drawingsurface"></div>
    </div>

</body>
</html>
