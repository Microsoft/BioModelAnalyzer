<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>LTL Formula View Sample</title>
    <link rel="stylesheet" type="text/css" href="../css/idd.css" />
    <link rel="stylesheet" href="../css/BMA_less.min.css" type="text/css" />
    <link rel="stylesheet" href="../css/StyleSheet.min.css" type="text/css" />

    <script src="../Scripts/jquery-2.1.1.min.js"></script>
    <script src="../Scripts/jquery-ui-1.10.4.min.js"></script>
    <script src="../js/jquery.svg.min.js"></script>
    <script src="../js/rx.js"></script>
    <script src="../js/rx.jQuery.js"></script>
    <script src="../js/idd.js"></script>
    <script src="../js/svgplot.js"></script>
    <script src="../tool.js"></script>

    <script>

        function GetOperationDepth(op) {

        }

        /*
        function GetOperationSVG(svg: any, position: { x: number; y: number }, op: BMA.LTLOperations.Operation): string {
            var operator = op.Operator;
            var operands = op.Operands;
            return GetOperatorSVG(svg, position, operator, operands);
        }

        function GetOperandSVG(svg: any, position: { x: number; y: number }, op: BMA.LTLOperations.IOperand): { svg: any; depthLevel: number } {

            //TODO: Rethink method of distingushing keyframes from operations
            var operator = (<any>op).Operator;

            if (operator !== undefined) {
                return GetOperationSVG(svg, position, <BMA.LTLOperations.Operation>op);
            } else {
                return {
                    svg: GetKeyFrameSVG(svg, position, <BMA.LTLOperations.Keyframe>op), depthLevel: 1
                };
            }
        }

        function GetKeyFrameSVG(svg: any, position: { x: number; y: number }, keyframe: BMA.LTLOperations.Keyframe): string {
            return "";
        }

        function GetOperatorSVG(svg: any, position: { x: number; y: number }, op: BMA.LTLOperations.Operator, operands: BMA.LTLOperations.IOperand[]): { svg: any; depthLevel: number } {
            if (operands.length !== op.OperandsCount)
                throw "Invalid Operands Count for Operator's rendering";

            var operandSVGs = [];
            for (var i = 0; i < operands.length; i++) {
                operandSVGs.push(GetOperandSVG(svg, position, operands[i]));
            }

            switch (operands.length) {
                case 1:
                    return {
                        svg: undefined,
                        depthLevel: (<any>operandSVGs[0]).depthLevel
                    }
                    break;
                case 2:
                    return {
                        svg: undefined,
                        depthLevel: Math.max((<any>operandSVGs[0]).depthLevel,(<any>operandSVGs[1]).depthLevel)
                    }
                    break;
                default:
                    throw "Rendering of operators with " + operands.length + " operands is not supported";
            }
        }
        */

        $(document).ready(function () {
            var plot = InteractiveDataDisplay.asPlot("figure");
            var svgPlot = plot.get("svgPlot");

            plot.yDataTransform =
                        new InteractiveDataDisplay.DataTransform(
                            function (x) {
                                return -x;
                            },
                            function (y) {
                                return -y;
                            },
                            undefined);

            var gestureSource = InteractiveDataDisplay.Gestures.getGesturesStream(plot.host);
            plot.navigation.gestureSource = gestureSource;
            plot.navigation.setVisibleRect({ x: 0, y: 0, width: 800, height: 600 }, false);
            var svgPlot = plot.get('svgPlot');
            var svg = svgPlot.svg;


            var formulacreator = function (funcname) {
                return function (op) {
                    var f = '(' + funcname;
                    for (var i = 0; i < op.length; i++) {
                        f += ' ' + op[i].GetFormula();
                    }
                    return f + ')';
                }
            }
            var k1 = new BMA.LTLOperations.Keyframe('one');
            var k2 = new BMA.LTLOperations.Keyframe('two');
            var k3 = new BMA.LTLOperations.Keyframe('three');
            var op1 = new BMA.LTLOperations.Operator('UNTIL', 2, formulacreator('Until'));
            var op2 = new BMA.LTLOperations.Operator('NOT', 1, formulacreator('Not'));
            var op3 = new BMA.LTLOperations.Operator('AND', 2, formulacreator('And'));
            var op = new BMA.LTLOperations.Operation();
            op.Operands = [k1, k2];
            op.Operator = op1;
            var opp = new BMA.LTLOperations.Operation();
            opp.Operands = [op];
            opp.Operator = op2;
            var opp2 = new BMA.LTLOperations.Operation();
            opp2.Operands = [op, k1];
            opp2.Operator = op3;
            var oppp = new BMA.LTLOperations.Operation();
            oppp.Operands = [k3, opp2];
            oppp.Operator = op3;

            //var operationLayout = new BMA.LTLOperations.OperationLayout(svg, oppp);

            var elementPanel = $("#elementPanel");
            var registry = new BMA.LTLOperations.OperatorsRegistry();
            for (var i = 0; i < registry.Operators.length; i++) {
                var operator = registry.Operators[i];

                $("<input></input>")
                    .attr("type", "radio")
                    .attr("id", "btn-" + operator.Name)
                    .attr("name", "drawing-button")
                    .attr("data-type", operator.Name)
                    .appendTo(elementPanel);

                var label = $("<label></label>").attr("data-operator", operator.Name).css("border", "none").css("border-radius", "50px 50px 50px 50px").attr("for", "btn-" + operator.Name).css("z-index", 9999999).appendTo(elementPanel);
                var img = $("<div></div>").css("overflow", "hidden").attr("title", operator.Name).appendTo(label);

                img.svg({
                    onLoad: function (svg) {
                        svg.configure({
                            width: img.width(),
                            height: img.height(),
                            viewBox: "-10 -10 20 20",
                            preserveAspectRatio: "none meet"
                        }, true);

                        var op = new BMA.LTLOperations.Operation();
                        op.Operator = registry.GetOperatorByName(operator.Name);
                        op.Operands = op.Operator.OperandsCount > 1 ? [undefined, undefined] : [undefined];
                        var operationLayout = new BMA.LTLOperations.OperationLayout(svg, op, { x: 0, y: 0 });

                        var bbox = operationLayout.BoundingBox;
                        svg.configure({
                            width: bbox.width,
                            height: bbox.height,
                            viewBox: (bbox.x - 1) + " " + (bbox.y - 1) + " " + (bbox.width + 2) + " " + (bbox.height + 2),
                            preserveAspectRatio: "none meet"
                        });

                        img.width(bbox.width).height(bbox.height);
                        label.width(bbox.width).height(bbox.height);
                    }
                });

                label.draggable({ helper: "clone" });
            }

            elementPanel.buttonset();

            var operations = [];

            $("#svgPlot").droppable({
                drop: function (event, ui) {
                    var op = new BMA.LTLOperations.Operation();
                    op.Operator = registry.GetOperatorByName(ui.draggable.attr("data-operator"));
                    op.Operands = op.Operator.OperandsCount > 1 ? [undefined, undefined] : [undefined];

                    var cs = svgPlot.getScreenToDataTransform();

                    var position = {
                        x: cs.screenToDataX(event.pageX - $("#svgPlot").offset().left),
                        y: -cs.screenToDataY(event.pageY - $("#svgPlot").offset().top)
                    };

                    var emptyCell = undefined;
                    for (var i = 0; i < operations.length; i++) {
                        emptyCell = operations[i].GetEmptySlotAtPosition(position.x, position.y);
                        if (emptyCell !== undefined) {
                            emptyCell.opLayout = operations[i];
                            break;
                        }
                    }

                    if (emptyCell === undefined) {
                        var operationLayout = new BMA.LTLOperations.OperationLayout(svg, op, position);
                        operations.push(operationLayout);
                    } else {
                        emptyCell.operation.Operands[emptyCell.operandIndex] = op;

                        emptyCell.opLayout.Position = emptyCell.opLayout.Position;
                    }
                }
            });
        });
    </script>
</head>
<body>

    <div id="tools" class="bma-toolbarpanel">
        <div id="elementPanel" class="elements-toolbar"></div>
    </div>

    <div id="figure" data-idd-plot="plot" style="width: 800px; height: 600px; border: 1px solid black;">
        <div id="svgPlot" data-idd-plot="svgPlot"></div>
    </div>
</body>
</html>
