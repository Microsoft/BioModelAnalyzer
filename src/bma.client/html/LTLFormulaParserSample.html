<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>LTL Results Viewer Sample</title>
    <link rel="stylesheet" type="text/css" href="../css/idd.css" />
    <link rel="stylesheet" href="../Content/themes/base/jquery.ui.all.css" type="text/css" />
    <link rel="stylesheet" href="../Content/themes/base/jquery-ui.css" type="text/css" />
    <link rel="stylesheet" href="../css/jquery.svg.css" type="text/css" />
    <link rel="stylesheet" href="../css/bma.css" />
    <script src="../Scripts/jquery-2.1.4.min.js"></script>
    <script src="../Scripts/jquery-ui-1.11.4.min.js"></script>
    <script src="../js/jquery.svg.js"></script>
    <script src="../Scripts/rx.lite.min.js"></script>
    <script src="../Scripts/rx.aggregates.min.js"></script>
    <script src="../js/idd.js"></script>
    <script src="../tool.js"></script>
    <script src="../js/jquery.ui-contextmenu.js"></script>
    <script src="../Scripts/formulaParser.js"></script>

    <script type="text/javascript">

        function ConvertFormulaToOperation(formula, states) {
            var parsedFormula;
            try {
                var parsedFormula = BMA.parser.parse(formula);
                var result = ConvertToOperation(parsedFormula, states);
                for (var i = 0; i < result.states.length; i++)
                    $("<p>" + result.states[i].Name + ": " + result.states[i].GetFormula() + "</p>").appendTo($("#textoutput"));
                return result.operation;
            } catch (ex) {
                alert(ex);
            }
            return;
        }

        function ConvertToOperation(formula, states) {
            if (formula && formula.state && states) {
                if (formula.state.variable === undefined) {
                    for (var i = 0; i < states.length; i++) {
                        if (states[i].Name == formula.state)
                            return { operation: states[i].Clone(), states: states };
                    }
                    if (formula.state.toUpperCase() == "OSCILLATION")
                        return { operation: new BMA.LTLOperations.OscillationKeyframe(), states: states };
                    if (formula.state.toUpperCase() == "SELFLOOP")
                        return { operation: new BMA.LTLOperations.SelfLoopKeyframe(), states: states };
                    if (formula.state.toUpperCase() == "TRUE")
                        return { operation: new BMA.LTLOperations.TrueKeyframe(), states: states };
                    return undefined;
                } else if (formula.state.variable && formula.state.operator && formula.state.const !== undefined) {
                    var state = new BMA.LTLOperations.Keyframe("A", "", [new BMA.LTLOperations.KeyframeEquation(new BMA.LTLOperations.NameOperand(formula.state.variable),
                        formula.state.operator, new BMA.LTLOperations.ConstOperand(formula.state.const))]);
                    var mergedStates = BMA.ModelHelper.MergeStates(states, [state]);
                    for (var i = 0; i < mergedStates.states.length; i++)
                        if (mergedStates.states[i].Name == mergedStates.map[state.Name])
                            return { operation: mergedStates.states[i].Clone(), states: mergedStates.states };
                    return undefined;
                }
            } else {
                if (formula && formula.operator) {
                    var operation = new BMA.LTLOperations.Operation();
                    var operands = [];
                    var operator = window.OperatorsRegistry.GetOperatorByName(formula.operator.toUpperCase());
                    if (operator === undefined) throw "Operator doesn't exist";
                    var newStates = [];
                    var formulaChanged = false;
                    for (i = 0; i < formula.operands.length; i++) {
                        var result = ConvertToOperation(formula.operands[i], states);
                        if (result !== undefined) {
                            newStates.push(result.states);
                            operands.push(result.operation);
                            if (result.formula) {
                                formula.operands[i] = result.formula;
                                formulaChanged = true;
                            }
                        } else {
                            operands.push(result);
                        }
                    }
                    if (operator.Name == "AND") {
                        if (formula.operands[0] && formula.operands[0].state && formula.operands[1] && formula.operands[1].state) {
                            //if (operands[0].GetFormula() == operands[1].GetFormula())
                            //    return { operation: operands[0].Clone(), states: states };
                            if (formula.operands[0].state.variable && formula.operands[1].state.variable) {
                                var newState = BMA.ModelHelper.MergeTwoStatesInOne(operands[0], operands[1]);
                                var mergedStates = BMA.ModelHelper.MergeStates(states, [newState]);
                                for (var i = 0; i < mergedStates.states.length; i++)
                                    if (mergedStates.states[i].Name == mergedStates.map[newState.Name]) {
                                        formula = { state: mergedStates.states[i].Name };
                                        return { operation: mergedStates.states[i].Clone(), states: mergedStates.states, formula: formula };
                                    }
                                return undefined;
                            } else if (formula.operands[0].state.variable && formulaChanged) {
                                for (var i = 0; i < newStates[1].length; i++)
                                    if (newStates[1][i].Name == formula.operands[1].state) {
                                        var newState = BMA.ModelHelper.MergeTwoStatesInOne(operands[0], newStates[1][i]);
                                        var mergedStates = BMA.ModelHelper.MergeStates(states, [newState]);
                                        for (var j = 0; j < mergedStates.states.length; j++)
                                            if (mergedStates.states[j].Name == mergedStates.map[newState.Name]) {
                                                formula = { state: mergedStates.states[j].Name };
                                                return { operation: mergedStates.states[j].Clone(), states: mergedStates.states, formula: formula };
                                            }
                                    }
                                return undefined;
                            } else if (formula.operands[1].state.variable && formulaChanged) {
                                for (var i = 0; i < newStates[0].length; i++)
                                    if (newStates[0][i].Name == formula.operands[0].state) {
                                        var newState = BMA.ModelHelper.MergeTwoStatesInOne(operands[1], newStates[0][i]);
                                        var mergedStates = BMA.ModelHelper.MergeStates(states, [newState]);
                                        for (var j = 0; j < mergedStates.states.length; j++)
                                            if (mergedStates.states[j].Name == mergedStates.map[newState.Name]) {
                                                formula = { state: mergedStates.states[j].Name };
                                                return { operation: mergedStates.states[j].Clone(), states: mergedStates.states, formula: formula };
                                            }
                                    }
                                return undefined;
                            } 
                        } 
                    }
                        
                    for (var i = 0; i < newStates.length; i++)
                        states = BMA.ModelHelper.MergeStates(states, newStates[i]).states;
                    
                    operation.Operator = operator;
                    operation.Operands = operands;
                    return { operation: operation, states: states, formula: formula };
                }
            }
            return undefined;
        }

        $(document).ready(function () {

            var svgDiv = $("#svgDiv");
            var jqSvg = undefined;
            var pixofs = 0;
            svgDiv.svg({
                onLoad: function (svg) {
                    jqSvg = svg;

                    svg.configure({
                        width: svgDiv.width() - pixofs,
                        height: svgDiv.height() - pixofs,
                        viewBox: "0 0 " + (svgDiv.width() - pixofs) + " " + (svgDiv.height() - pixofs),
                        preserveAspectRatio: "none meet"
                    }, true);


                    //that._refresh();
                }
            });

            function RenderToSvg(svgDiv, svg, operation) {
                svg.clear();
                var operationLayout = new BMA.LTLOperations.OperationLayout(svg, operation, { x: 0, y: 0 });
                var bbox = operationLayout.BoundingBox;
                var aspect = svgDiv.width() / svgDiv.height();
                var width = bbox.width + 20;
                var height = width / aspect;
                if (height < bbox.height + 20) {
                    height = bbox.height + 20;
                    width = height * aspect;
                }
                var x = -width / 2;
                var y = -height / 2;
                svg.configure({
                    viewBox: x + " " + y + " " + width + " " + height,
                }, true);
            }

            window.OperatorsRegistry = new BMA.LTLOperations.OperatorsRegistry();

            $("#inp").change(function () {
                try {
                    $("#textoutput").text("");
                    var parsed = ConvertFormulaToOperation($("#inp").val(),
                        [
                            new BMA.LTLOperations.Keyframe("A", "", []),
                            new BMA.LTLOperations.Keyframe("B", "", []),
                            new BMA.LTLOperations.Keyframe("C", "", []),
                            new BMA.LTLOperations.Keyframe("D", "",
                                [new BMA.LTLOperations.KeyframeEquation(new BMA.LTLOperations.NameOperand("a"), "=", new BMA.LTLOperations.ConstOperand(2))]),
                        ]);

                    RenderToSvg(svgDiv, jqSvg, parsed);
                    //$("#textoutput").text(JSON.stringify(parsed));
                } catch (ex) {
                    $("#textoutput").text(ex);
                }
            });
        });

    </script>
</head>
<body style="background-color: white;">
    <div style="width:450px; height: 250px;">
        <div id="textbox" style="width:200px;height: 200px;float:left;background-color: aliceblue;">
            <textarea type="text" id="inp" style="margin:0px;width:190px;height: 190px;border:none; background-color:transparent;">Enter formula</textarea>
        </div>
        <div id="textoutput" style="width:200px;height: 200px;float:left;background-color: cornsilk;">
        </div>

        <div id="svgDiv" style="width:400px;height:250px;"></div>
    </div>
</body>
</html>
